# æ‰‹å‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ï¼ˆç®¡ç†è€…æ¨©é™ä¸è¶³ã®å ´åˆï¼‰

## ðŸš¨ å•é¡Œ

`canale.dev` ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ä»¥ä¸‹ã®æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ï¼š

- `iam:CreatePolicy`
- `iam:PutUserPolicy`

ãã®ãŸã‚ã€è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆ`setup-iam.sh`ï¼‰ãŒå®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚

## ðŸ“ æ›´æ–°æƒ…å ±

**æœ€æ–°ç‰ˆï¼ˆv1.2ï¼‰**: ä»¥ä¸‹ã® IAM ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼š

- `iam:ListRoles` - Terraform ãŒãƒ­ãƒ¼ãƒ«ä¸€è¦§ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«å¿…è¦
- `iam:ListRoleTags` - ãƒ­ãƒ¼ãƒ«ã®ã‚¿ã‚°ã‚’èª­ã¿å–ã‚‹ãŸã‚ã«å¿…è¦
- `iam:ListRolePolicies` - ãƒ­ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒªã‚·ãƒ¼ä¸€è¦§ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«å¿…è¦
- `iam:AttachRolePolicy` - ç®¡ç†ãƒãƒªã‚·ãƒ¼ã‚’ãƒ­ãƒ¼ãƒ«ã«ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ãŸã‚ã«å¿…è¦
- `iam:DetachRolePolicy` - ç®¡ç†ãƒãƒªã‚·ãƒ¼ã‚’ãƒ­ãƒ¼ãƒ«ã‹ã‚‰ãƒ‡ã‚¿ãƒƒãƒã™ã‚‹ãŸã‚ã«å¿…è¦
- `iam:ListAttachedRolePolicies` - ãƒ­ãƒ¼ãƒ«ã«ã‚¢ã‚¿ãƒƒãƒã•ã‚ŒãŸç®¡ç†ãƒãƒªã‚·ãƒ¼ã‚’ä¸€è¦§å–å¾—ã™ã‚‹ãŸã‚ã«å¿…è¦ï¼ˆé‡è¦ï¼ï¼‰

ã“ã‚Œã‚‰ãŒãªã„ã¨ `terraform plan` ã‚„ `terraform apply` å®Ÿè¡Œæ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚

## âœ… è§£æ±ºæ–¹æ³•

ç®¡ç†è€…æ¨©é™ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã¾ãŸã¯ AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦æ‰‹å‹•ã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

---

## ðŸ“‹ æ‰‹é † 1: AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆ

### 1-1. IAM ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’é–‹ã

1. [AWS IAM ã‚³ãƒ³ã‚½ãƒ¼ãƒ«](https://console.aws.amazon.com/iam/)ã«ã‚¢ã‚¯ã‚»ã‚¹
2. å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ **ã€Œãƒãƒªã‚·ãƒ¼ã€** ã‚’é¸æŠž
3. **ã€Œãƒãƒªã‚·ãƒ¼ã®ä½œæˆã€** ã‚’ã‚¯ãƒªãƒƒã‚¯

### 1-2. ãƒãƒªã‚·ãƒ¼ JSON ã‚’å…¥åŠ›

1. **ã€ŒJSONã€** ã‚¿ãƒ–ã‚’é¸æŠž
2. `[iam-policy-for-terraform]`ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆï¼š

3. **ã€Œæ¬¡ã¸ã€** ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ãƒãƒªã‚·ãƒ¼å: **`TerraformDailyCostMonitorPolicy`**
5. èª¬æ˜Žï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰: `Policy for Terraform to manage Daily Cost Monitor resources`
6. **ã€Œãƒãƒªã‚·ãƒ¼ã®ä½œæˆã€** ã‚’ã‚¯ãƒªãƒƒã‚¯

---

## ðŸ“‹ æ‰‹é † 2: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒ

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³ A: æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆcanale.devï¼‰ã«è¿½åŠ 

1. IAM ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ **ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã€** ã‚’é¸æŠž
2. **`canale.dev`** ã‚’ã‚¯ãƒªãƒƒã‚¯
3. **ã€Œã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã€** ã‚¿ãƒ–
4. **ã€Œã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’è¿½åŠ ã€** â†’ **ã€Œãƒãƒªã‚·ãƒ¼ã‚’ç›´æŽ¥ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ã€**
5. æ¤œç´¢æ¬„ã« `TerraformDailyCostMonitorPolicy` ã¨å…¥åŠ›
6. ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ ON
7. **ã€Œæ¬¡ã¸ã€** â†’ **ã€Œã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’è¿½åŠ ã€**

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³ B: æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆï¼ˆæŽ¨å¥¨ï¼‰

1. IAM ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ **ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã€** ã‚’é¸æŠž
2. **ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã€** ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼å: **`terraform-daily-cost`**
4. **ã€Œæ¬¡ã¸ã€**
5. **ã€Œãƒãƒªã‚·ãƒ¼ã‚’ç›´æŽ¥ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ã€** ã‚’é¸æŠž
6. `TerraformDailyCostMonitorPolicy` ã‚’æ¤œç´¢ã—ã¦é¸æŠž
7. **ã€Œæ¬¡ã¸ã€** â†’ **ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆã€**

---

## ðŸ“‹ æ‰‹é † 3: ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’ä½œæˆ

### 3-1. ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã®ä½œæˆ

1. ä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆã¾ãŸã¯ `canale.dev`ï¼‰ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ã
2. **ã€Œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£èªè¨¼æƒ…å ±ã€** ã‚¿ãƒ–
3. **ã€Œã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’ä½œæˆã€** ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹: **ã€ŒCommand Line Interface (CLI)ã€** ã‚’é¸æŠž
5. ç¢ºèªãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ ON
6. **ã€Œæ¬¡ã¸ã€**
7. èª¬æ˜Žã‚¿ã‚°ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰: `Terraform for daily-cost-monitor`
8. **ã€Œã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’ä½œæˆã€**

### 3-2. èªè¨¼æƒ…å ±ã‚’ä¿å­˜

âš ï¸ **é‡è¦**: ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å®‰å…¨ã«ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚

---

## ðŸ“‹ æ‰‹é † 4: AWS CLI ã®è¨­å®š

### ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§å®Ÿè¡Œ

```bash
# æ–°ã—ã„ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
aws configure --profile daily-cost-terraform

# ä»¥ä¸‹ã‚’å…¥åŠ›
AWS Access Key ID: [ä¸Šè¨˜ã§å–å¾—ã—ãŸã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ID]
AWS Secret Access Key: [ä¸Šè¨˜ã§å–å¾—ã—ãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼]
Default region name: ap-northeast-1
Default output format: json
```

ã¾ãŸã¯ã€ç›´æŽ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ï¼š

```bash
# ~/.aws/credentials ã«è¿½åŠ 
cat >> ~/.aws/credentials <<EOF

[daily-cost-terraform]
aws_access_key_id = YOUR_ACCESS_KEY_ID
aws_secret_access_key = YOUR_SECRET_ACCESS_KEY
EOF

# ~/.aws/config ã«è¿½åŠ 
cat >> ~/.aws/config <<EOF

[profile daily-cost-terraform]
region = ap-northeast-1
output = json
EOF
```

---

## ðŸ“‹ æ‰‹é † 5: Terraform ã‚’å®Ÿè¡Œ

```bash
cd /Users/canale/Documents/daily-cost

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
cp terraform.tfvars.example terraform.tfvars

# terraform.tfvars ã‚’ç·¨é›†
vim terraform.tfvars
# notification_email ã‚’è¨­å®š

# ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­å®š
export AWS_PROFILE=daily-cost-terraform

# Terraformå®Ÿè¡Œ
terraform init
terraform plan
terraform apply
```

---

## ðŸ” ç¢ºèªæ–¹æ³•

### ãƒãƒªã‚·ãƒ¼ãŒæ­£ã—ãä½œæˆã•ã‚ŒãŸã‹ç¢ºèª

```bash
aws iam get-policy --policy-arn arn:aws:iam::010526250511:policy/TerraformDailyCostMonitorPolicy
```

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒãƒªã‚·ãƒ¼ãŒã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

```bash
# ç®¡ç†ãƒãƒªã‚·ãƒ¼ã®ç¢ºèª
aws iam list-attached-user-policies --user-name canale.dev

# ã¾ãŸã¯æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆ
aws iam list-attached-user-policies --user-name terraform-daily-cost
```

### å‹•ä½œç¢ºèª

```bash
# èªè¨¼æƒ…å ±ã®ç¢ºèª
aws sts get-caller-identity --profile daily-cost-terraform

# å‡ºåŠ›ä¾‹:
# {
#     "UserId": "AIDAXXXXXXXXXX",
#     "Account": "010526250511",
#     "Arn": "arn:aws:iam::010526250511:user/terraform-daily-cost"
# }
```

---

## ðŸŽ¯ ç®¡ç†è€…ã¸ã®ä¾é ¼ãƒ¡ãƒ¼ãƒ«æ–‡ä¾‹

ã‚‚ã—è‡ªåˆ†ã§å®Ÿè¡Œã§ããªã„å ´åˆã€ç®¡ç†è€…ã«ä»¥ä¸‹ã®ã‚ˆã†ãªä¾é ¼ãƒ¡ãƒ¼ãƒ«ã‚’é€ã£ã¦ãã ã•ã„ï¼š

```
ä»¶å: Terraformå®Ÿè¡Œç”¨IAMãƒãƒªã‚·ãƒ¼ã®ä½œæˆä¾é ¼

ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚

AWS Daily Cost Monitorã‚·ã‚¹ãƒ†ãƒ ã®æ§‹ç¯‰ã«ã‚ãŸã‚Šã€
Terraformå®Ÿè¡Œç”¨ã®IAMãƒãƒªã‚·ãƒ¼ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

â–  å¿…è¦ãªä½œæ¥­
1. IAMãƒãƒªã‚·ãƒ¼ã®ä½œæˆ
   - ãƒãƒªã‚·ãƒ¼å: TerraformDailyCostMonitorPolicy
   - ãƒãƒªã‚·ãƒ¼JSON: æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã€Œiam-policy-compact.jsonã€ã‚’å‚ç…§

2. ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã‚’å®Ÿæ–½
   a) æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆcanale.devï¼‰ã«ä¸Šè¨˜ãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒ
   b) æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆterraform-daily-costï¼‰ã‚’ä½œæˆã—ã€ãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒ

3. ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã®ç™ºè¡Œï¼ˆCLIå®Ÿè¡Œç”¨ï¼‰

â–  ãƒ•ã‚¡ã‚¤ãƒ«
- ãƒãƒªã‚·ãƒ¼JSON: iam-policy-compact.json
- è©³ç´°æ‰‹é †: MANUAL_SETUP.md

ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
```

---

## ðŸ“š é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- **iam-policy-compact.json** - ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆç‰ˆãƒãƒªã‚·ãƒ¼ï¼ˆæŽ¨å¥¨ï¼‰
- **iam-policy-for-terraform.json** - è©³ç´°ç‰ˆãƒãƒªã‚·ãƒ¼
- **TERRAFORM_SETUP.md** - è©³ç´°ãªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰
- **QUICKSTART.md** - ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚¬ã‚¤ãƒ‰

---

## â“ ã‚ˆãã‚ã‚‹è³ªå•

### Q: ãªãœè‡ªå‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒä½¿ãˆãªã„ã®ã‹ï¼Ÿ

A: IAM ãƒãƒªã‚·ãƒ¼ã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹ã«ã¯ã€é«˜ã„æ¨©é™ãŒå¿…è¦ã§ã™ã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã€ã“ã‚Œã‚‰ã®æ¨©é™ã¯ç®¡ç†è€…ã®ã¿ã«ä»˜ä¸Žã•ã‚Œã¦ã„ã¾ã™ã€‚

### Q: canale.dev ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç›´æŽ¥æ¨©é™ã‚’è¿½åŠ ã§ããªã„ã‹ï¼Ÿ

A: å¯èƒ½ã§ã™ãŒã€ä»¥ä¸‹ã®æ¨©é™ãŒå¿…è¦ã§ã™ï¼š

- `iam:CreatePolicy`
- `iam:AttachUserPolicy`
- `iam:PutUserPolicy`

ã“ã‚Œã‚‰ã¯ç®¡ç†è€…æ¨©é™ãƒ¬ãƒ™ãƒ«ã®æ“ä½œã§ã™ã€‚

### Q: åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚‚ä½¿ãˆã‚‹ã‹ï¼Ÿ

A: ã¯ã„ã€‚ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ IDï¼ˆ010526250511ï¼‰ã¯è‡ªå‹•çš„ã«èªè­˜ã•ã‚Œã‚‹ãŸã‚ã€åŒã˜ãƒãƒªã‚·ãƒ¼ã‚’ä»–ã® AWS ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚‚ä½¿ç”¨ã§ãã¾ã™ã€‚

---

## ðŸ†˜ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼: "Policy document is too large"

â†’ `iam-policy-compact.json` ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼ˆ713 æ–‡å­—ï¼‰

### ã‚¨ãƒ©ãƒ¼: "AccessDenied"

â†’ ç®¡ç†è€…æ¨©é™ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å®Ÿè¡Œã™ã‚‹ã‹ã€AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§æ‰‹å‹•ä½œæˆã—ã¦ãã ã•ã„

### ãƒãƒªã‚·ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„

â†’ æ­£ã—ã„ AWS ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„

---

## ðŸ“… å¤‰æ›´å±¥æ­´

- **v1.2 (2024-12-22)**: IAM ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ ï¼ˆ`iam:AttachRolePolicy`, `iam:DetachRolePolicy`, `iam:ListAttachedRolePolicies`ï¼‰- ç®¡ç†ãƒãƒªã‚·ãƒ¼æ“ä½œã®ã‚µãƒãƒ¼ãƒˆ
- **v1.1 (2024-12-22)**: IAM ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ ï¼ˆ`iam:ListRoles`, `iam:ListRoleTags`, `iam:ListRolePolicies`ï¼‰- Terraform å®Ÿè¡Œæ™‚ã®ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£
- **v1.0 (2024-12-22)**: åˆç‰ˆãƒªãƒªãƒ¼ã‚¹

**ä½œæˆæ—¥**: 2024 å¹´ 12 æœˆ 22 æ—¥
**æœ€çµ‚æ›´æ–°**: 2024 å¹´ 12 æœˆ 22 æ—¥
