name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write

env:
  PYTHON_VERSION: "3.11"
  TERRAFORM_VERSION: "1.0"

jobs:
  terraform-format:
    name: Terraform Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive .

  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        run: terraform validate

  tfsec:
    name: Terraform Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.0
        with:
          working_directory: '.'
          format: 'default'
          soft_fail: true

  python-format:
    name: Python Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: |
            lambda/requirements.txt
            lambda/requirements-dev.txt

      - name: Install dependencies
        run: |
          pip install black

      - name: Check formatting with Black
        run: black --check lambda/

  python-lint:
    name: Python Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: |
            lambda/requirements.txt
            lambda/requirements-dev.txt

      - name: Install dependencies
        run: |
          pip install pylint boto3

      - name: Run Pylint
        run: pylint lambda/*.py --exit-zero
        continue-on-error: true

  bandit:
    name: Python Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install bandit

      - name: Run Bandit
        run: bandit -r lambda/ -f json -o bandit-report.json || true
        continue-on-error: true

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-report
          path: bandit-report.json
          retention-days: 30

  python-tests:
    name: Python Tests & Coverage
    runs-on: ubuntu-latest
    env:
      AWS_DEFAULT_REGION: us-east-1
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: dummy
      AWS_SECRET_ACCESS_KEY: dummy
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: |
            lambda/requirements.txt
            lambda/requirements-dev.txt

      - name: Install dependencies
        run: |
          pip install -r lambda/requirements-dev.txt

      - name: Run tests with coverage
        run: |
          cd lambda && pytest \
            --cov=. \
            --cov-report=html \
            --cov-report=term \
            --cov-report=xml \
            --junitxml=test-results.xml \
            -v

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: lambda/htmlcov
          retention-days: 30

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: lambda/test-results.xml
          retention-days: 30

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: lambda/test-results.xml
          check_name: "Test Results"
          comment_mode: off

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [terraform-format, terraform-validate, tfsec, python-format, python-lint, bandit, python-tests]
    steps:
      - name: Check job results
        run: |
          echo "Terraform Format: ${{ needs.terraform-format.result }}"
          echo "Terraform Validate: ${{ needs.terraform-validate.result }}"
          echo "Terraform Security: ${{ needs.tfsec.result }}"
          echo "Python Format: ${{ needs.python-format.result }}"
          echo "Python Lint: ${{ needs.python-lint.result }}"
          echo "Python Security: ${{ needs.bandit.result }}"
          echo "Python Tests: ${{ needs.python-tests.result }}"

      - name: Check for failures
        if: |
          needs.terraform-format.result == 'failure' ||
          needs.terraform-validate.result == 'failure' ||
          needs.python-format.result == 'failure' ||
          needs.python-tests.result == 'failure'
        run: |
          echo "Critical CI checks failed!"
          exit 1
